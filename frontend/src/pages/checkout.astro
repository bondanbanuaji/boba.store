---
import Layout from "../layouts/Layout.astro";
import { formatCurrency } from "../lib/utils";
import { ShoppingBag, CreditCard, AlertCircle } from "lucide-astro";

const productId = Astro.url.searchParams.get('product');
const denominationId = Astro.url.searchParams.get('denomination');
const targetId = Astro.url.searchParams.get('target');
const targetServer = Astro.url.searchParams.get('server');

if (!productId) {
  return Astro.redirect('/products');
}

const paymentMethods = [
  { id: "qris", name: "QRIS", icon: "ðŸ“±", fee: 0, category: "E-Wallet" },
  { id: "dana", name: "DANA", icon: "ðŸ‘›", fee: 0, category: "E-Wallet" },
  { id: "gopay", name: "GoPay", icon: "ðŸŸ¢", fee: 0, category: "E-Wallet" },
  { id: "ovo", name: "OVO", icon: "ðŸ’œ", fee: 0, category: "E-Wallet" },
  { id: "shopeepay", name: "ShopeePay", icon: "ðŸ§¡", fee: 0, category: "E-Wallet" },
  { id: "va_bca", name: "BCA Virtual Account", icon: "ðŸ¦", fee: 2500, category: "Bank Transfer" },
  { id: "va_bni", name: "BNI Virtual Account", icon: "ðŸ¦", fee: 2500, category: "Bank Transfer" },
  { id: "va_bri", name: "BRI Virtual Account", icon: "ðŸ¦", fee: 2500, category: "Bank Transfer" },
  { id: "va_mandiri", name: "Mandiri Virtual Account", icon: "ðŸ¦", fee: 2500, category: "Bank Transfer" },
];

const groupedMethods = paymentMethods.reduce((acc, method) => {
  if (!acc[method.category]) acc[method.category] = [];
  acc[method.category].push(method);
  return acc;
}, {});
---

<Layout>
  <section class="py-12 bg-gradient-to-b from-[var(--color-primary)]/10 to-transparent">
    <div class="container mx-auto px-4 text-center">
      <h1 class="text-4xl md:text-5xl font-bold text-white mb-6">
        <span class="text-gradient">Checkout</span>
      </h1>
      <p class="text-white/60 max-w-2xl mx-auto">
        Pilih metode pembayaran dan selesaikan transaksi.
      </p>
    </div>
  </section>

  <section class="py-12">
    <div class="container mx-auto px-4 max-w-4xl">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Order Summary -->
        <div class="lg:col-span-1">
          <div class="glass rounded-2xl p-6 sticky top-24">
            <div class="flex items-center gap-3 mb-6">
              <ShoppingBag class="w-6 h-6 text-[var(--color-primary)]" />
              <h2 class="text-lg font-bold text-white">Ringkasan Pesanan</h2>
            </div>

            <div class="space-y-4 mb-6">
              <div class="flex justify-between">
                <span class="text-white/60">Produk</span>
                <span class="text-white font-medium" id="product-name">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-white/60">Nominal</span>
                <span class="text-white font-medium" id="denomination-name">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-white/60">Target ID</span>
                <span class="text-white font-medium">{targetId || '-'}{targetServer ? ` (${targetServer})` : ''}</span>
              </div>
            </div>

            <div class="h-px bg-white/10 mb-4"></div>

            <div class="space-y-2 mb-6">
              <div class="flex justify-between text-sm">
                <span class="text-white/60">Harga</span>
                <span class="text-white" id="base-price">Rp 0</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-white/60">Biaya Admin</span>
                <span class="text-white" id="admin-fee">Rp 0</span>
              </div>
            </div>

            <div class="h-px bg-white/10 mb-4"></div>

            <div class="flex justify-between">
              <span class="text-white font-bold">Total</span>
              <span class="text-2xl font-bold text-[var(--color-primary)]" id="total-price">Rp 0</span>
            </div>
          </div>
        </div>

        <!-- Payment Methods -->
        <div class="lg:col-span-2 space-y-6">
          <form id="checkout-form">
            <input type="hidden" name="productId" value={productId} />
            <input type="hidden" name="denominationId" value={denominationId} />
            <input type="hidden" name="targetId" value={targetId} />
            <input type="hidden" name="targetServer" value={targetServer} />

            {Object.entries(groupedMethods).map(([category, methods]) => (
              <div class="glass rounded-2xl p-6 mb-6">
                <div class="flex items-center gap-3 mb-6">
                  <CreditCard class="w-6 h-6 text-[var(--color-primary)]" />
                  <h2 class="text-lg font-bold text-white">{category}</h2>
                </div>

                <div class="space-y-3">
                  {methods.map((method) => (
                    <label class="block cursor-pointer">
                      <input
                        type="radio"
                        name="paymentMethod"
                        value={method.id}
                        data-fee={method.fee}
                        class="peer hidden"
                      />
                      <div class="p-4 rounded-xl bg-black/20 border border-white/10 peer-checked:border-[var(--color-primary)] peer-checked:bg-[var(--color-primary)]/10 hover:border-white/20 transition-all flex items-center justify-between">
                        <div class="flex items-center gap-4">
                          <span class="text-2xl">{method.icon}</span>
                          <span class="font-medium text-white">{method.name}</span>
                        </div>
                        <div class="text-right">
                          <p class="text-sm text-white/60">
                            {method.fee > 0 ? `+${formatCurrency(method.fee)}` : 'Gratis'}
                          </p>
                        </div>
                      </div>
                    </label>
                  ))}
                </div>
              </div>
            ))}

            <!-- Contact Info -->
            <div class="glass rounded-2xl p-6 mb-6">
              <h2 class="text-lg font-bold text-white mb-6">Informasi Kontak</h2>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-white/70 mb-2">Email</label>
                  <input
                    type="email"
                    name="email"
                    required
                    placeholder="email@example.com"
                    class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white placeholder:text-white/40 focus:outline-none focus:border-[var(--color-primary)] transition-colors"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-white/70 mb-2">No. WhatsApp (Opsional)</label>
                  <input
                    type="tel"
                    name="whatsapp"
                    placeholder="08xxxxxxxxxx"
                    class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white placeholder:text-white/40 focus:outline-none focus:border-[var(--color-primary)] transition-colors"
                  />
                </div>
              </div>
            </div>

            <!-- Submit -->
            <button
              type="submit"
              id="submit-btn"
              class="w-full py-4 rounded-xl bg-[var(--color-primary)] text-white font-bold text-lg hover:brightness-110 transition-all shadow-[0_0_30px_rgba(147,51,234,0.3)] disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Bayar Sekarang
            </button>

            <p class="text-center text-white/40 text-sm mt-4">
              Dengan melanjutkan, Anda menyetujui <a href="/terms" class="text-[var(--color-primary)] hover:underline">Syarat & Ketentuan</a> kami.
            </p>
          </form>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  const form = document.getElementById('checkout-form') as HTMLFormElement;
  const paymentInputs = document.querySelectorAll('input[name="paymentMethod"]');
  const adminFeeEl = document.getElementById('admin-fee');
  const totalPriceEl = document.getElementById('total-price');
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

  let basePrice = 0;
  let adminFee = 0;

  function formatCurrency(amount: number) {
    return new Intl.NumberFormat('id-ID', {
      style: 'currency',
      currency: 'IDR',
      minimumFractionDigits: 0,
    }).format(amount);
  }

  function updateTotal() {
    if (adminFeeEl) adminFeeEl.textContent = formatCurrency(adminFee);
    if (totalPriceEl) totalPriceEl.textContent = formatCurrency(basePrice + adminFee);
  }

  paymentInputs.forEach(input => {
    input.addEventListener('change', (e) => {
      const target = e.target as HTMLInputElement;
      adminFee = parseInt(target.dataset.fee || '0', 10);
      updateTotal();
    });
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const selectedPayment = formData.get('paymentMethod');
    
    if (!selectedPayment) {
      alert('Pilih metode pembayaran');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Memproses...';

    try {
      const response = await fetch('/api/orders/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          productId: formData.get('productId'),
          denominationId: formData.get('denominationId'),
          targetId: formData.get('targetId'),
          targetServer: formData.get('targetServer'),
          paymentMethod: selectedPayment,
          email: formData.get('email'),
          whatsapp: formData.get('whatsapp'),
        }),
      });

      const result = await response.json();

      if (result.success && result.data?.paymentUrl) {
        window.location.href = result.data.paymentUrl;
      } else if (result.success && result.data?.orderId) {
        window.location.href = `/track?id=${result.data.orderId}`;
      } else {
        alert(result.error || 'Terjadi kesalahan');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Bayar Sekarang';
      }
    } catch (err) {
      alert('Terjadi kesalahan jaringan');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Bayar Sekarang';
    }
  });

  updateTotal();
</script>
